<%inherit file="base.html"/>

<%namespace name="blocks" file="common/blocks.html"/>
<%namespace name="tiles" file="common/tiles.html"/>

<%def name="title()">${project.name}</%def>


<%def name="breadcrumbs(project)">
  <ol class="breadcrumb breadcrumb-project">
    <li>Creators</li>
    <li>
      <a href="${request.node_url(project.creator)}">
        ${project.creator.name}
      </a>
    </li>
  </ol>
</%def>


<%def name="tab(suffix)">
  % if suffix == action:
    <li class="active">
      <a href="#">${caller.body()}</a>
    </li>
  % else:
    <li>
      <a href="${request.node_url(project, suffix=[suffix] if suffix else None)}">${caller.body()}</a>
    </li>
  % endif
</%def>


<%def name="project_update(update)">
  <div class="update">
    <div class="update-date pull-right">
      ## FIXME
      ##<p class="month">${update.created_time.strftime('%b')}</p>
      ##<p class="day">${update.created_time.strftime('%d')}</p>
    </div>
    <a href="${request.node_url(update)}"><h3>${update.name}</h3></a>
    <p>${request.render_content(update, update.body)}</p>
    ## FIXME
    ##<div class="clearfix">
    ##  <div class="social-wrap">
    ##    <a href="${h.facebook_share_url(url=request.node_url(update), text='', caption='Crowd Supply Update', name=update.name, image_url='http://%s%s' % (request.host, update.img_url('project-main')), app_id=request.site.settings['facebook.app_id'], redirect_uri=request.url)}">
    ##      <i class="icon-facebook"></i>
    ##    </a>
    ##  </div>
    ##  <div class="social-wrap">
    ##    <a href="${h.twitter_tweet_url(text=update.name, via='crowd_supply', url=request.node_url(update))}">
    ##      <i class="icon-twitter"></i>
    ##    </a>
    ##  </div>
    ##</div>
  </div>
</%def>


<%def name="social_buttons(project)">
  <div class="row">
    <div class="col-xs-4">
      <a href="${h.project_facebook_url(request, project)}">
        <i class="fa fa-facebook"></i>
      </a>
    </div>
    <div class="col-xs-4">
      <a href="${h.project_twitter_url(request, project)}">
        <i class="fa fa-twitter"></i>
      </a>
    </div>
    <div class="col-xs-4">
      <a href="${h.project_pin_it_url(request, project)}">
        <i class="fa fa-pinterest"></i>
      </a>
    </div>
  </div>
</%def>


<%def name="stats_crowdfunding(project)">
  <p class="pledged">
    <span><sup>$</sup>${h.commas(project.pledged_amount)}</span>&nbsp;raised
  </p>
  <p class="goal">
    of&nbsp;<span><sup>$</sup>${h.commas(project.target)}</span>&nbsp;goal
  </p>

  <div class="progress">
    <div class="progress-bar" style="width: ${project.progress_percent}%"></div>
  </div>

  <div class="factoids row">
    <div class="fact col-xs-4" data-countdown-to="${project.end_time.isoformat()}">
      <%
        val, units = project.remaining
      %>
      <p>${val}</p>
      <span>${units} left</span>
    </div>
    <div class="fact col-xs-4">
      <p>${h.format_percent(project.progress_percent)}<sup>%</sup></p>
      <span>funded</span>
    </div>
    <div class="fact col-xs-4">
      <p>${h.commas(project.num_pledges)}</p>
      <span>pledges</span>
    </div>
  </div>

  <div class="social-buttons">
    <p>Support this project on social media!</p>
    ${self.social_buttons(project)}
  </div>
</%def>


<%def name="stats_suspended(project)">
</%def>


<%def name="stats_funded(project)">
</%def>


<%def name="stats_prelaunch(project)">
</%def>


<%def name="stats_available(project)">
</%def>


<%def name="stats_tile(project)">
  <div class="project-block">
    % if project.status == 'crowdfunding':
      ${self.stats_crowdfunding(project)}
    % elif project.status == 'suspended':
      ${self.stats_suspended(project)}
    % elif project.status == 'funded':
      ${self.stats_funded(project)}
    % elif project.status == 'prelaunch':
      ${self.stats_prelaunch(project)}
    % elif project.status == 'available':
      ${self.stats_available(project)}
    % endif
  </div>
</%def>


<%def name="pledge_levels(project)">
  <div class="project-block">
    % for pledge_level in project.published_levels:
      <form class="form-horizontal" method="post" action="${request.route_path('cart:add')}">
        <div class="pledge-level">
          ${pledge_level.img(request, 'pledge-icon')}
          <h3>${pledge_level.name}</h3>
          <div class="pledge-level-price">${h.currency(pledge_level.price)}</div>

          ${h.hidden('product_id', pledge_level.id)}

          % for option in pledge_level.published_options:
            <div class="form-group">
              <label class="col-xs-4 control-label" for="option-${option.id}">${option.name}</label>
              <div class="col-xs-8">
                <select id="option-${option.id}" name="option-${loop.index}.value_id" class="form-control">
                  % for value in option.published_values:
                    <option value="${value.id}">${value.description}</option>
                  % endfor
                </select>
              </div>
            </div>
          % endfor

          <div class="form-group">
            <div class="col-xs-8 col-xs-offset-4">
              ## XXX FIXME
              <button class="btn btn-cta">Back This Project</button>
            </div>
          </div>
        </div>
      </form>
      % if not loop.last:
        <hr>
      % endif
    % endfor
  </div>
</%def>


% if request.user and request.user.has_permission('admin'):
  <section class="section-admin-bar">
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <p>
            <a href="${request.route_path('admin:project', id=project.id)}">
              Edit Project ${project.id} - ${project.name}
            </a>
          </p>
        </div>
      </div>
    </div>
  </section>
% endif


<section class="section-project">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        ${self.breadcrumbs(project)}
      </div>
    </div>

    <div class="row">
      <div class="col-lg-12">
        <div class="pull-right">
          % if project.creator.location:
            <p>
              <i class="fa fa-map-marker"></i>&nbsp;
              ${project.creator.location}
            </p>
          % endif
          % for tag in list(project.tags)[:2]:
            % if tag.published:
              <p>
                <i class="fa fa-tag"></i>
                <a href="${request.node_url(tag)}">${tag.name}</a>
              </p>
            % endif
          % endfor
        </div>

        <h1>${project.name}</h1>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-12">
        <ul class="nav nav-tabs">
          <%self:tab suffix="${None}">
            Home
          </%self:tab>
          <%self:tab suffix="updates">
            Updates
            <span class="badge">${len(project.published_updates)}</span>
          </%self:tab>
          <%self:tab suffix="backers">
            Backers
          </%self:tab>
        </ul>
      </div>
    </div>

    <div class="row">
      <div class="col-md-8">
        ${next.body()}
      </div>
      <div class="col-md-4">
        ${self.stats_tile(project)}
        ${self.pledge_levels(project)}
      </div>
    </div>

    <div class="row">
      <div class="col-lg-12">
        <div class="project-block">
          <div class="row">
            <div class="col-sm-3">
              ${project.creator.img(request, 'creator-profile')}
            </div>

            <div class="col-sm-9">
              <h4>${project.creator.name}</h4>
              <div class="creator-block-teaser">${project.creator.teaser}</div>
              <div class="creator-block-metadata">
                <i class="fa fa-map-marker"></i>&nbsp;${project.creator.location}
                % if project.creator.home_url:
                  &nbsp;&middot;&nbsp;
                  <a href="${project.creator.home_url}">${project.creator.display_url}</a>
                % endif
              </div>
            </div>
          </div>

          % if project.published_ownerships:
            <div class="row">
              <div class="col-lg-12">
                <hr>
              </div>
            </div>
            <div class="row">
              % for owner in project.published_ownerships:
                <div class="col-xs-6 col-sm-3">
                  <div class="project-owner">
                    ${h.image_or_gravatar(request, owner.user, 'project-avatar', default='mm', title=owner.user.name, class_='img-avatar')}
                    <h4>${owner.user.name}</h4>
                    <p>${owner.title}</p>
                  </div>
                </div>
              % endfor
            </div>
          % endif
        </div>
      </div>
    </div>
  </div>
</section>


% if project.related_projects:
  <section class="section-related-projects">
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <h1 class="text-center">Similar Projects</h1>
        </div>
      </div>

      % for row in h.grouper(4, project.related_projects):
        ${tiles.tile_row(row)}
      % endfor
    </div>
  </section>
% endif

#############################################################################
# File templated by Ansible
# Base template: {{ template_path }}
# User: {{ template_uid }} on {{ template_host }}
#############################################################################

user www-data www-data;

worker_processes  2;

error_log  /var/log/nginx/error.log error;
pid        /var/run/nginx.pid;

events {
  worker_connections  1024;
}

http {
  server_names_hash_bucket_size 64;

  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  # Logging
  log_format  main '$remote_addr	"$remote_user"	$time_local	$msec	$status	"$request"	$body_bytes_sent	"$http_referer"	"$http_user_agent"	"$http_x_forwarded_for"	$request_time';

  access_log  /var/log/nginx/access.log  main;

  # File Uploads
  client_body_temp_path      /var/spool/nginx-client-body 1 2;
  client_max_body_size       500m;
  client_body_buffer_size    128k;

  # Caching
  proxy_cache_path           /var/spool/nginx-cache levels=1:2 keys_zone=main-cache:25m max_size=1000m inactive=600m;
  proxy_temp_path            /var/spool/nginx-cache/tmp;
  proxy_cache_use_stale updating;

  uwsgi_cache_path           /var/spool/uwsgi-cache levels=1:2 keys_zone=uwsgi-cache:25m inactive=600m;

  # TCP Features
  sendfile       on;
  tcp_nopush     on;
  tcp_nodelay    on;

  # Disable version banners
  server_tokens   off;

  # Compression
  gzip on;
  gzip_http_version 1.0;
  gzip_comp_level 2;
  gzip_proxied any;
  gzip_min_length  1100;
  gzip_buffers 16 8k;
  gzip_types text/plain text/css application/x-javascript
      text/xml application/xml application/xml+rss text/javascript
      application/javascript;

  # Some version of IE 6 don't handle compression well on some
  # mime-types, so just disable for them
  gzip_disable "MSIE [1-6].(?!.*SV1)";

  # Set a vary header so downstream proxies don't send cached gzipped
  # content to IE6
  gzip_vary on;

  # Increase some hash bucket sizes
  map_hash_bucket_size 1024;

  # Certain robots have no legitimate use
  map $http_user_agent $is_robot {
    ~nutch.apache.org 1;
    ~*FDM\ 3.x 1;
  }

  # Include VHosts
  include /etc/nginx/sites-enabled/*;
}
